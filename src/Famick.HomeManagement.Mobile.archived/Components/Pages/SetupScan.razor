@page "/setup/scan"
@layout EmptyLayout
@inject NavigationManager Navigation
@inject IServiceProvider ServiceProvider
@using Famick.HomeManagement.Mobile.Services
@using Famick.HomeManagement.Mobile.Pages

<MudThemeProvider Theme="_theme" IsDarkMode="false" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudContainer MaxWidth="MaxWidth.Small" Class="d-flex align-center" Style="height: 100vh;">
    <MudPaper Elevation="3" Class="pa-8" Style="width: 100%;">
        @if (_scanResult != null)
        {
            @* Show confirmation after scanning *@
            <MudStack Spacing="4" AlignItems="AlignItems.Center">
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large" Color="Color.Success" />
                <MudText Typo="Typo.h5">Server Found</MudText>
            </MudStack>

            <MudStack Spacing="2" Class="mt-6">
                <MudText Typo="Typo.body1"><strong>Server URL:</strong></MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">@_scanResult.ServerUrl</MudText>

                @if (!string.IsNullOrEmpty(_scanResult.ServerName))
                {
                    <MudText Typo="Typo.body1" Class="mt-2"><strong>Server Name:</strong></MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">@_scanResult.ServerName</MudText>
                }
            </MudStack>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mt-4">@_errorMessage</MudAlert>
            }

            @if (_testSuccess)
            {
                <MudAlert Severity="Severity.Success" Class="mt-4">Connection successful!</MudAlert>
            }

            <MudStack Row="true" Spacing="2" Class="mt-6">
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Primary"
                           OnClick="@TestConnection"
                           Disabled="@_isTesting"
                           Style="flex: 1;">
                    @if (_isTesting)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <span>Testing...</span>
                    }
                    else
                    {
                        <span>Test Connection</span>
                    }
                </MudButton>

                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           OnClick="@ApplySettings"
                           Disabled="@_isApplying"
                           Style="flex: 1;">
                    @if (_isApplying)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <span>Applying...</span>
                    }
                    else
                    {
                        <span>Connect</span>
                    }
                </MudButton>
            </MudStack>

            <MudButton Variant="Variant.Text"
                       Color="Color.Secondary"
                       FullWidth="true"
                       OnClick="@ScanAgain"
                       Class="mt-2">
                Scan Different QR Code
            </MudButton>
        }
        else
        {
            @* Initial state - prompt to scan *@
            <MudStack Spacing="4" AlignItems="AlignItems.Center">
                <MudIcon Icon="@Icons.Material.Filled.QrCodeScanner" Size="Size.Large" Color="Color.Primary" />
                <MudText Typo="Typo.h5">Setup Server Connection</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center">
                    Scan the QR code displayed on your self-hosted server's Mobile App Setup page.
                </MudText>
            </MudStack>

            <MudStack Spacing="2" Class="mt-6">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           FullWidth="true"
                           Size="Size.Large"
                           OnClick="@StartScan"
                           StartIcon="@Icons.Material.Filled.QrCodeScanner">
                    Scan QR Code
                </MudButton>

                <MudButton Variant="Variant.Text"
                           Color="Color.Secondary"
                           FullWidth="true"
                           OnClick="@(() => Navigation.NavigateTo("/settings/server"))">
                    Enter URL Manually
                </MudButton>

                <MudButton Variant="Variant.Text"
                           Color="Color.Secondary"
                           FullWidth="true"
                           OnClick="@(() => Navigation.NavigateTo("/login"))">
                    Back to Login
                </MudButton>
            </MudStack>
        }
    </MudPaper>
</MudContainer>

@code {
    private SetupQrResult? _scanResult;
    private bool _isTesting;
    private bool _isApplying;
    private bool _testSuccess;
    private string? _errorMessage;

    private DeepLinkHandler? _deepLinkHandler;
    private ApiSettings? _apiSettings;

    private readonly MudTheme _theme = new()
    {
        PaletteLight = new PaletteLight()
        {
            Primary = Colors.Blue.Default,
            Secondary = Colors.Green.Accent4,
        }
    };

    protected override void OnInitialized()
    {
        _deepLinkHandler = ServiceProvider.GetService<DeepLinkHandler>();
        _apiSettings = ServiceProvider.GetService<ApiSettings>();

        // Check if there's a pending deep link from app startup
        if (_deepLinkHandler?.PendingServerUrl != null)
        {
            _scanResult = new SetupQrResult(
                _deepLinkHandler.PendingServerUrl,
                _deepLinkHandler.PendingServerName);
        }
    }

    private async Task StartScan()
    {
        if (_deepLinkHandler == null) return;

        try
        {
            var scannerPage = new SetupQrScannerPage(_deepLinkHandler);
            var navigation = Application.Current?.Windows?.FirstOrDefault()?.Page?.Navigation;

            if (navigation != null)
            {
                await navigation.PushModalAsync(scannerPage);
                var result = await scannerPage.ScanAsync();

                if (result != null)
                {
                    _scanResult = result;
                    _testSuccess = false;
                    _errorMessage = null;
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to open scanner: {ex.Message}";
        }
    }

    private async Task TestConnection()
    {
        if (_scanResult == null) return;

        _isTesting = true;
        _errorMessage = null;
        _testSuccess = false;

        try
        {
            using var httpClient = new HttpClient();
            httpClient.Timeout = TimeSpan.FromSeconds(10);

            var testUrl = _scanResult.ServerUrl.TrimEnd('/') + "/health";
            var response = await httpClient.GetAsync(testUrl);

            if (response.IsSuccessStatusCode)
            {
                _testSuccess = true;
            }
            else
            {
                _errorMessage = $"Server returned status {(int)response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Connection failed: {ex.Message}";
        }
        finally
        {
            _isTesting = false;
        }
    }

    private async Task ApplySettings()
    {
        if (_scanResult == null || _apiSettings == null || _deepLinkHandler == null) return;

        _isApplying = true;
        _errorMessage = null;

        try
        {
            _deepLinkHandler.ApplyPendingSettings();
            await Task.Delay(500); // Brief delay for visual feedback
            Navigation.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to apply settings: {ex.Message}";
        }
        finally
        {
            _isApplying = false;
        }
    }

    private void ScanAgain()
    {
        _scanResult = null;
        _testSuccess = false;
        _errorMessage = null;
        _deepLinkHandler?.ClearPendingSettings();
    }
}
