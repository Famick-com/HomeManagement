<?xml version="1.0" encoding="utf-8" ?>
<toolkit:Popup xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
               xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
               xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
               xmlns:popups="clr-namespace:Famick.HomeManagement.Mobile.Popups"
               xmlns:models="clr-namespace:Famick.HomeManagement.Mobile.Models"
               x:Class="Famick.HomeManagement.Mobile.Popups.AddAddressPopup"
               x:TypeArguments="models:AddAddressResult"
               Padding="10">

    <Border Padding="24" StrokeShape="RoundRectangle 16" Stroke="Transparent" StrokeThickness="0"
            BackgroundColor="{AppThemeBinding Light=White, Dark=#2A2A2A}" WidthRequest="340">
        <ScrollView MaximumHeightRequest="560">
            <VerticalStackLayout Spacing="12">

                <!-- Form View (default) -->
                <VerticalStackLayout x:Name="FormSection" Spacing="12">
                    <Label x:Name="TitleLabel" Text="Add Address" FontSize="20" FontAttributes="Bold" HorizontalOptions="Center" />

                    <Entry x:Name="Line1Entry" Placeholder="Address Line 1" TextChanged="OnLine1TextChanged" />

                    <!-- Search results dropdown (shown below Line1Entry when results exist) -->
                    <CollectionView x:Name="SearchResultsView"
                                    IsVisible="false"
                                    MaximumHeightRequest="150"
                                    SelectionMode="Single"
                                    SelectionChanged="OnSearchResultSelected"
                                    Margin="0,-8,0,0">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:AddressDto">
                                <Border Padding="8,6" Margin="0,1"
                                        StrokeShape="RoundRectangle 6"
                                        Stroke="{AppThemeBinding Light=#E0E0E0, Dark=#424242}"
                                        BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#333333}">
                                    <VerticalStackLayout Spacing="2">
                                        <Label Text="{Binding AddressLine1}" FontSize="14" />
                                        <Label Text="{Binding DisplayAddress}" FontSize="12" TextColor="Gray" LineBreakMode="TailTruncation" />
                                    </VerticalStackLayout>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <Label x:Name="SelectedAddressLabel"
                           IsVisible="false"
                           FontSize="13" TextColor="{AppThemeBinding Light=#1976D2, Dark=#64B5F6}" />

                    <Entry x:Name="Line2Entry" Placeholder="Address Line 2 (optional)" />
                    <Entry x:Name="CityEntry" Placeholder="City" />
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                        <Entry x:Name="StateEntry" Grid.Column="0" Placeholder="State/Province" />
                        <Entry x:Name="PostalEntry" Grid.Column="1" Placeholder="Postal Code" />
                    </Grid>
                    <Entry x:Name="CountryEntry" Placeholder="Country" />

                    <VerticalStackLayout Spacing="4">
                        <Label Text="Type" FontSize="13" TextColor="Gray" />
                        <Picker x:Name="TagPicker">
                            <Picker.Items>
                                <x:String>Home</x:String>
                                <x:String>Work</x:String>
                                <x:String>School</x:String>
                                <x:String>Previous</x:String>
                                <x:String>Vacation</x:String>
                                <x:String>Other</x:String>
                            </Picker.Items>
                        </Picker>
                    </VerticalStackLayout>

                    <Grid ColumnDefinitions="*,Auto">
                        <Label Text="Set as primary" VerticalOptions="Center" />
                        <Switch x:Name="PrimarySwitch" Grid.Column="1" />
                    </Grid>

                    <!-- Verifying indicator -->
                    <HorizontalStackLayout x:Name="VerifyingIndicator" IsVisible="false" Spacing="8" HorizontalOptions="Center">
                        <ActivityIndicator IsRunning="true" WidthRequest="20" HeightRequest="20"
                                           Color="{AppThemeBinding Light=#1976D2, Dark=#64B5F6}" />
                        <Label Text="Verifying address..." FontSize="13"
                               TextColor="{AppThemeBinding Light=#1976D2, Dark=#64B5F6}" VerticalOptions="Center" />
                    </HorizontalStackLayout>

                    <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                        <Button Grid.Column="0" Text="Cancel" Clicked="OnCancelClicked"
                                BackgroundColor="{AppThemeBinding Light=#E0E0E0, Dark=#424242}"
                                TextColor="{AppThemeBinding Light=Black, Dark=White}"
                                CornerRadius="20" HeightRequest="44" />
                        <Button x:Name="SaveButton" Grid.Column="1" Text="Add" Clicked="OnAddClicked"
                                BackgroundColor="{AppThemeBinding Light=#1976D2, Dark=#1565C0}"
                                TextColor="White" CornerRadius="20" HeightRequest="44" />
                    </Grid>
                </VerticalStackLayout>

                <!-- Verification View (shown when address needs confirmation) -->
                <VerticalStackLayout x:Name="VerificationSection" IsVisible="false" Spacing="12">
                    <Label Text="Verify Address" FontSize="20" FontAttributes="Bold" HorizontalOptions="Center" />
                    <Label Text="We found a verified version of your address. Which would you like to use?"
                           FontSize="13" TextColor="Gray" HorizontalTextAlignment="Center" />

                    <!-- Verified address option -->
                    <Border x:Name="VerifiedAddressBorder" Padding="12"
                            StrokeShape="RoundRectangle 10"
                            Stroke="{AppThemeBinding Light=#1976D2, Dark=#64B5F6}"
                            StrokeThickness="2"
                            BackgroundColor="{AppThemeBinding Light=#E3F2FD, Dark=#1A237E}">
                        <VerticalStackLayout Spacing="4">
                            <HorizontalStackLayout Spacing="6">
                                <Label Text="&#x2713;" FontSize="16" TextColor="{AppThemeBinding Light=#1976D2, Dark=#64B5F6}" />
                                <Label Text="Verified Address" FontSize="14" FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light=#1976D2, Dark=#64B5F6}" />
                            </HorizontalStackLayout>
                            <Label x:Name="VerifiedAddressText" FontSize="13" />
                        </VerticalStackLayout>
                    </Border>

                    <!-- Original address option -->
                    <Border x:Name="OriginalAddressBorder" Padding="12"
                            StrokeShape="RoundRectangle 10"
                            Stroke="{AppThemeBinding Light=#E0E0E0, Dark=#424242}"
                            StrokeThickness="1"
                            BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#333333}">
                        <VerticalStackLayout Spacing="4">
                            <Label Text="Original Address" FontSize="14" FontAttributes="Bold" TextColor="Gray" />
                            <Label x:Name="OriginalAddressText" FontSize="13" />
                        </VerticalStackLayout>
                    </Border>

                    <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8">
                        <Button Grid.Column="0" Text="Back" Clicked="OnVerificationBackClicked"
                                BackgroundColor="{AppThemeBinding Light=#E0E0E0, Dark=#424242}"
                                TextColor="{AppThemeBinding Light=Black, Dark=White}"
                                CornerRadius="20" HeightRequest="44" FontSize="13" />
                        <Button Grid.Column="1" Text="Keep Original" Clicked="OnKeepOriginalClicked"
                                BackgroundColor="{AppThemeBinding Light=#FF9800, Dark=#E65100}"
                                TextColor="White" CornerRadius="20" HeightRequest="44" FontSize="13" />
                        <Button Grid.Column="2" Text="Use Verified" Clicked="OnUseVerifiedClicked"
                                BackgroundColor="{AppThemeBinding Light=#4CAF50, Dark=#2E7D32}"
                                TextColor="White" CornerRadius="20" HeightRequest="44" FontSize="13" />
                    </Grid>
                </VerticalStackLayout>

            </VerticalStackLayout>
        </ScrollView>
    </Border>
</toolkit:Popup>
