<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:ios="clr-namespace:Microsoft.Maui.Controls.PlatformConfiguration.iOSSpecific;assembly=Microsoft.Maui.Controls"             
             x:Class="Famick.HomeManagement.Mobile.Pages.ShoppingSessionPage"
             Title="{Binding ListName}"
             SafeAreaEdges="None"
             BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#121212}">

    <Shell.BackButtonBehavior>
        <BackButtonBehavior Command="{Binding BackCommand}" />
    </Shell.BackButtonBehavior>

    <ContentPage.ToolbarItems>
        <ToolbarItem Order="Primary"
                     Clicked="OnAisleOrderClicked"
                     IconImageSource="pencil" />
    </ContentPage.ToolbarItems>

    <Grid ios:Page.UseSafeArea="True">

        <!-- Offline Banner -->
        <Border x:Name="OfflineBanner"
                IsVisible="False"
                Padding="10"
                Margin="0"
                StrokeShape="RoundRectangle 0"
                Stroke="Transparent"
                StrokeThickness="0"
                BackgroundColor="#FFF3E0"
                VerticalOptions="Start"
                ZIndex="10"> <!-- Ensure banner is on top -->
            <HorizontalStackLayout Spacing="10" HorizontalOptions="Center">
                <Label Text="Offline Mode" FontAttributes="Bold" TextColor="#E65100" VerticalOptions="Center" />
                <Label Text="Changes will sync when online" FontSize="12" TextColor="#F57C00" VerticalOptions="Center" />
            </HorizontalStackLayout>
        </Border>

        <!-- Main Content -->
        <RefreshView
                     x:Name="RefreshContainer"
                     Refreshing="OnRefreshing"
                     BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#121212}">
            <CollectionView x:Name="ItemsCollection"
                            BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#121212}"
                            ItemsSource="{Binding GroupedItems}"
                            IsGrouped="True"
                            SelectionMode="None">

                <!-- Group Header (Aisle/Department) -->
                <CollectionView.GroupHeaderTemplate>
                    <DataTemplate>
                        <Border Padding="15,10" Margin="0" StrokeShape="RoundRectangle 0" Stroke="Transparent" StrokeThickness="0"
                                BackgroundColor="{AppThemeBinding Light=#E3F2FD, Dark=#1A237E}">
                            <Label Text="{Binding Key}"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light=#1565C0, Dark=#90CAF9}" />
                        </Border>
                    </DataTemplate>
                </CollectionView.GroupHeaderTemplate>

                <!-- Item Template -->
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <SwipeView>
                            <SwipeView.RightItems>
                                <SwipeItems>
                                    <SwipeItem Text="Remove"
                                               BackgroundColor="#F44336"
                                               Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.RemoveItemCommand}"
                                               CommandParameter="{Binding}" />
                                </SwipeItems>
                            </SwipeView.RightItems>

                            <Border Padding="10" Margin="5,2" StrokeShape="RoundRectangle 8" Stroke="Transparent" StrokeThickness="0"
                                    BackgroundColor="{AppThemeBinding Light=White, Dark=#2A2A2A}">
                                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="10">

                                    <!-- Checkbox -->
                                    <CheckBox Grid.Column="0"
                                              IsChecked="{Binding IsPurchased}"
                                              CheckedChanged="OnItemCheckedChanged"
                                              VerticalOptions="Center"
                                              Color="{AppThemeBinding Light=#1976D2, Dark=#90CAF9}" />

                                    <!-- Product Info -->
                                    <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="2">
                                        <Label Text="{Binding ProductName}"
                                               FontSize="16"
                                               TextDecorations="{Binding IsPurchased, Converter={StaticResource BoolToStrikethroughConverter}}"
                                               Opacity="{Binding IsPurchased, Converter={StaticResource BoolToOpacityConverter}}" />
                                        <HorizontalStackLayout Spacing="10">
                                            <Label Text="{Binding Amount, StringFormat='Qty: {0}'}"
                                                   FontSize="12"
                                                   TextColor="Gray" />
                                            <Label Text="{Binding Price, StringFormat='${0:F2}'}"
                                                   FontSize="12"
                                                   TextColor="Gray"
                                                   IsVisible="{Binding HasPrice}" />
                                        </HorizontalStackLayout>
                                    </VerticalStackLayout>

                                    <!-- Product Image -->
                                    <Image Grid.Column="2"
                                           Source="{Binding ImageSource}"
                                           WidthRequest="50"
                                           HeightRequest="50"
                                           Aspect="AspectFill"
                                           IsVisible="{Binding HasImage}" />
                                </Grid>
                            </Border>
                        </SwipeView>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
                <CollectionView.Footer>
                    <BoxView HeightRequest="100" Color="{AppThemeBinding Light=#F5F5F5, Dark=#121212}" />
                </CollectionView.Footer>
            </CollectionView>
        </RefreshView>

        <!-- Loading Overlay -->
        <ActivityIndicator x:Name="LoadingIndicator"
                           IsRunning="False"
                           IsVisible="False"
                           VerticalOptions="Center"
                           HorizontalOptions="Center" />
        <!-- Bottom Panel -->
        <Grid VerticalOptions="End"
              Padding="15"
              ColumnDefinitions="*,Auto"
              BackgroundColor="{AppThemeBinding Light=#F5F5F5E8, Dark=#1A1A1AE8}">

            <Grid.Padding>
                <OnPlatform x:TypeArguments="Thickness">
                    <On Platform="iOS" Value="15, 15, 15, 35" /> 
                </OnPlatform>
            </Grid.Padding>

            <!-- Subtotal -->
            <VerticalStackLayout Grid.Column="0" VerticalOptions="Center">
                <Label x:Name="SubtotalLabel"
                       FontSize="18"
                       FontAttributes="Bold" />
                <Label x:Name="SubtotalNote"
                       FontSize="12"
                       TextColor="Gray" />
            </VerticalStackLayout>

            <!-- Action Buttons -->
            <HorizontalStackLayout Grid.Column="1" Spacing="10">
                <!-- Add Item Button -->
                <Button x:Name="AddItemButton"
                        Text="+"
                        Clicked="OnAddItemClicked"
                        BackgroundColor="{AppThemeBinding Light=#FF9800, Dark=#F57C00}"
                        TextColor="White"
                        FontSize="20"
                        FontAttributes="Bold"
                        CornerRadius="22"
                        HeightRequest="45"
                        WidthRequest="45" />

                <!-- Scan Button -->
                <Button x:Name="ScanButton"
                        Text="Scan"
                        Clicked="OnScanClicked"
                        BackgroundColor="{AppThemeBinding Light=#1976D2, Dark=#1565C0}"
                        TextColor="White"
                        CornerRadius="20"
                        HeightRequest="45"
                        WidthRequest="80" />

                <!-- Complete Button -->
                <Button x:Name="CompleteButton"
                        Text="Done"
                        Clicked="OnCompleteClicked"
                        BackgroundColor="#4CAF50"
                        TextColor="White"
                        CornerRadius="20"
                        HeightRequest="45"
                        WidthRequest="80" />
            </HorizontalStackLayout>
        </Grid>
    </Grid>
</ContentPage>
