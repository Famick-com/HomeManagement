<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="Famick.HomeManagement.Mobile.Pages.ChildProductSelectionPage"
             Title="Select Variant"
             BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#121212}">

    <Grid RowDefinitions="Auto,*,Auto">

        <!-- Parent Product Info Header -->
        <Border Grid.Row="0"
                Padding="15"
                Margin="10,10,10,5"
                StrokeShape="RoundRectangle 12"
                Stroke="Transparent"
                BackgroundColor="{AppThemeBinding Light=White, Dark=#2A2A2A}">
            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="15">
                <!-- Parent Image -->
                <Image x:Name="ParentImage"
                       Grid.Column="0"
                       WidthRequest="60"
                       HeightRequest="60"
                       Aspect="AspectFill"
                       IsVisible="False" />
                <Border x:Name="ParentNoImage"
                        Grid.Column="0"
                        WidthRequest="60"
                        HeightRequest="60"
                        StrokeShape="RoundRectangle 8"
                        Stroke="Transparent"
                        BackgroundColor="{AppThemeBinding Light=#E0E0E0, Dark=#3A3A3A}">
                    <Label Text="ðŸ“¦"
                           FontSize="24"
                           HorizontalOptions="Center"
                           VerticalOptions="Center" />
                </Border>

                <!-- Parent Info -->
                <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="4">
                    <Label x:Name="ParentNameLabel"
                           FontSize="18"
                           FontAttributes="Bold"
                           LineBreakMode="TailTruncation" />
                    <HorizontalStackLayout Spacing="10">
                        <Label x:Name="QuantityLabel"
                               FontSize="14"
                               TextColor="Gray" />
                        <Label x:Name="ProgressLabel"
                               FontSize="14"
                               TextColor="{AppThemeBinding Light=#1976D2, Dark=#90CAF9}" />
                    </HorizontalStackLayout>
                    <!-- Progress Bar -->
                    <ProgressBar x:Name="QuantityProgress"
                                 Progress="0"
                                 ProgressColor="{AppThemeBinding Light=#4CAF50, Dark=#81C784}"
                                 HeightRequest="6" />
                </VerticalStackLayout>
            </Grid>
        </Border>

        <!-- Child Products List -->
        <RefreshView Grid.Row="1"
                     x:Name="RefreshContainer"
                     Refreshing="OnRefreshing"
                     Margin="10,0">
            <CollectionView x:Name="ChildrenCollection"
                            ItemsSource="{Binding ChildProducts}"
                            SelectionMode="None">
                <CollectionView.EmptyView>
                    <VerticalStackLayout VerticalOptions="Center"
                                         HorizontalOptions="Center"
                                         Spacing="10"
                                         Padding="20">
                        <Label Text="No variants available at this store"
                               FontSize="16"
                               TextColor="Gray"
                               HorizontalOptions="Center" />
                        <Label Text="You can check off the parent product directly"
                               FontSize="14"
                               TextColor="Gray"
                               HorizontalOptions="Center" />
                    </VerticalStackLayout>
                </CollectionView.EmptyView>

                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Border Padding="12"
                                Margin="0,5"
                                StrokeShape="RoundRectangle 10"
                                Stroke="Transparent"
                                BackgroundColor="{AppThemeBinding Light=White, Dark=#2A2A2A}">
                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">

                                <!-- Product Image -->
                                <Image Grid.Column="0"
                                       Source="{Binding ImageUrl}"
                                       WidthRequest="55"
                                       HeightRequest="55"
                                       Aspect="AspectFill"
                                       IsVisible="{Binding ImageUrl, Converter={StaticResource StringNotNullConverter}}" />
                                <Border Grid.Column="0"
                                        WidthRequest="55"
                                        HeightRequest="55"
                                        StrokeShape="RoundRectangle 8"
                                        Stroke="Transparent"
                                        BackgroundColor="{AppThemeBinding Light=#F0F0F0, Dark=#3A3A3A}"
                                        IsVisible="{Binding ImageUrl, Converter={StaticResource StringNullConverter}}">
                                    <Label Text="ðŸ·ï¸"
                                           FontSize="20"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center" />
                                </Border>

                                <!-- Product Info -->
                                <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="3">
                                    <Label Text="{Binding ProductName}"
                                           FontSize="15"
                                           FontAttributes="Bold"
                                           LineBreakMode="TailTruncation" />

                                    <!-- Price and Location -->
                                    <HorizontalStackLayout Spacing="8">
                                        <Label Text="{Binding LastKnownPrice, StringFormat='${0:F2}'}"
                                               FontSize="14"
                                               TextColor="{AppThemeBinding Light=#4CAF50, Dark=#81C784}"
                                               IsVisible="{Binding LastKnownPrice, Converter={StaticResource NullableToBoolConverter}}" />
                                        <Label Text="{Binding Aisle, StringFormat='Aisle {0}'}"
                                               FontSize="12"
                                               TextColor="Gray"
                                               IsVisible="{Binding Aisle, Converter={StaticResource StringNotNullConverter}}" />
                                    </HorizontalStackLayout>

                                    <!-- Stock Status -->
                                    <HorizontalStackLayout Spacing="5">
                                        <Label Text="âœ“ In Stock"
                                               FontSize="12"
                                               TextColor="#4CAF50"
                                               IsVisible="{Binding InStock, TargetNullValue=False}" />
                                        <Label Text="âš  Out of Stock"
                                               FontSize="12"
                                               TextColor="#F44336"
                                               IsVisible="{Binding InStock, Converter={StaticResource InverseBoolConverter}, TargetNullValue=False}" />
                                        <Label Text="{Binding PurchasedQuantity, StringFormat='({0} purchased)'}"
                                               FontSize="12"
                                               TextColor="{AppThemeBinding Light=#1976D2, Dark=#90CAF9}"
                                               IsVisible="{Binding PurchasedQuantity, Converter={StaticResource GreaterThanZeroConverter}}" />
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>

                                <!-- Actions -->
                                <VerticalStackLayout Grid.Column="2"
                                                     VerticalOptions="Center"
                                                     Spacing="8">
                                    <!-- Check Off Button -->
                                    <Button Text="âœ“"
                                            BackgroundColor="{AppThemeBinding Light=#4CAF50, Dark=#388E3C}"
                                            TextColor="White"
                                            FontSize="16"
                                            CornerRadius="20"
                                            HeightRequest="40"
                                            WidthRequest="40"
                                            Clicked="OnCheckOffClicked"
                                            CommandParameter="{Binding}" />

                                </VerticalStackLayout>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <!-- Loading Overlay -->
        <ActivityIndicator x:Name="LoadingIndicator"
                           Grid.Row="1"
                           IsRunning="False"
                           IsVisible="False"
                           VerticalOptions="Center"
                           HorizontalOptions="Center" />

        <!-- Bottom Actions -->
        <Border Grid.Row="2"
                Padding="15"
                StrokeShape="RoundRectangle 0"
                Stroke="Transparent"
                BackgroundColor="{AppThemeBinding Light=#F5F5F5E8, Dark=#1A1A1AE8}">
            <Border.Padding>
                <OnPlatform x:TypeArguments="Thickness">
                    <On Platform="iOS" Value="15, 15, 15, 35" />
                    <On Platform="Android" Value="15" />
                </OnPlatform>
            </Border.Padding>
            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="15">
                <Button x:Name="CheckOffParentButton"
                        Grid.Column="0"
                        Text="Check Off Parent Directly"
                        BackgroundColor="{AppThemeBinding Light=#E0E0E0, Dark=#424242}"
                        TextColor="{AppThemeBinding Light=Black, Dark=White}"
                        CornerRadius="22"
                        HeightRequest="44"
                        Clicked="OnCheckOffParentClicked" />
                <Button x:Name="DoneButton"
                        Grid.Column="1"
                        Text="Done"
                        BackgroundColor="{AppThemeBinding Light=#1976D2, Dark=#1565C0}"
                        TextColor="White"
                        CornerRadius="22"
                        HeightRequest="44"
                        WidthRequest="80"
                        Clicked="OnDoneClicked" />
            </Grid>
        </Border>
    </Grid>
</ContentPage>
