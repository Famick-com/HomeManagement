<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="Famick.HomeManagement.Mobile.Pages.Recipes.RecipeListPage"
             Title="Recipes"
             Shell.NavBarIsVisible="True">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Add" Clicked="OnAddRecipeClicked" IconImageSource="plus" />
    </ContentPage.ToolbarItems>

    <Grid RowDefinitions="Auto,Auto,*">

        <!-- Search -->
        <Entry x:Name="SearchEntry"
               Grid.Row="0"
               Placeholder="Search recipes..."
               ReturnType="Search"
               TextChanged="OnSearchTextChanged"
               Margin="10,5" />

        <!-- Sort Picker -->
        <Grid Grid.Row="1" ColumnDefinitions="Auto,*" Padding="15,0,15,5">
            <Label Text="Sort by:"
                   VerticalOptions="Center"
                   FontSize="13"
                   TextColor="Gray" />
            <Picker x:Name="SortPicker"
                    Grid.Column="1"
                    SelectedIndexChanged="OnSortChanged"
                    Margin="5,0,0,0">
                <Picker.Items>
                    <x:String>Name</x:String>
                    <x:String>Recently Updated</x:String>
                    <x:String>Recently Created</x:String>
                </Picker.Items>
            </Picker>
        </Grid>

        <!-- Loading Indicator -->
        <ActivityIndicator x:Name="LoadingIndicator"
                           Grid.Row="2"
                           IsRunning="True"
                           IsVisible="True"
                           VerticalOptions="Center"
                           HorizontalOptions="Center"
                           Color="{AppThemeBinding Light=#1976D2, Dark=#90CAF9}" />

        <!-- Empty State -->
        <VerticalStackLayout x:Name="EmptyState"
                             Grid.Row="2"
                             IsVisible="False"
                             VerticalOptions="Center"
                             HorizontalOptions="Center"
                             Spacing="10">
            <Label Text="No Recipes"
                   FontSize="18"
                   FontAttributes="Bold"
                   HorizontalOptions="Center" />
            <Label Text="Tap + to create your first recipe."
                   FontSize="14"
                   TextColor="Gray"
                   HorizontalOptions="Center" />
            <Button Text="Refresh"
                    Clicked="OnRefreshClicked"
                    Margin="0,20,0,0" />
        </VerticalStackLayout>

        <!-- Recipe List -->
        <RefreshView x:Name="RefreshContainer"
                     Grid.Row="2"
                     IsVisible="False"
                     Refreshing="OnRefreshing">
            <CollectionView x:Name="RecipeCollection"
                            ItemsSource="{Binding Recipes}"
                            SelectionMode="Single"
                            SelectionChanged="OnRecipeSelected">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <SwipeView>
                            <SwipeView.RightItems>
                                <SwipeItems>
                                    <SwipeItem Text="Edit"
                                               BackgroundColor="#1976D2"
                                               Invoked="OnEditSwiped"
                                               BindingContext="{Binding}" />
                                    <SwipeItem Text="Delete"
                                               BackgroundColor="#D32F2F"
                                               Invoked="OnDeleteSwiped"
                                               BindingContext="{Binding}" />
                                </SwipeItems>
                            </SwipeView.RightItems>
                            <Border Margin="10,4" Padding="12" StrokeShape="RoundRectangle 10"
                                    Stroke="Transparent" StrokeThickness="0"
                                    BackgroundColor="{AppThemeBinding Light=White, Dark=#2A2A2A}">
                                <Grid ColumnDefinitions="60,*,Auto" ColumnSpacing="12">
                                    <!-- Thumbnail -->
                                    <Border Grid.Column="0"
                                            WidthRequest="60" HeightRequest="60"
                                            StrokeShape="RoundRectangle 8"
                                            Stroke="Transparent"
                                            BackgroundColor="{AppThemeBinding Light=#F0F0F0, Dark=#3A3A3A}">
                                        <Image Source="{Binding ThumbnailSource}"
                                               Aspect="AspectFill"
                                               WidthRequest="60"
                                               HeightRequest="60" />
                                    </Border>

                                    <!-- Info -->
                                    <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="2">
                                        <Label Text="{Binding Name}"
                                               FontSize="16"
                                               FontAttributes="Bold"
                                               LineBreakMode="TailTruncation"
                                               MaxLines="1" />
                                        <Label FontSize="12" TextColor="Gray">
                                            <Label.Text>
                                                <MultiBinding StringFormat="{}{0} steps · {1} servings">
                                                    <Binding Path="StepCount" />
                                                    <Binding Path="Servings" />
                                                </MultiBinding>
                                            </Label.Text>
                                        </Label>
                                        <Label Text="{Binding Source}"
                                               FontSize="11"
                                               TextColor="Gray"
                                               LineBreakMode="TailTruncation"
                                               MaxLines="1">
                                            <Label.Triggers>
                                                <DataTrigger TargetType="Label"
                                                             Binding="{Binding Source}"
                                                             Value="{x:Null}">
                                                    <Setter Property="IsVisible" Value="False" />
                                                </DataTrigger>
                                                <DataTrigger TargetType="Label"
                                                             Binding="{Binding Source}"
                                                             Value="">
                                                    <Setter Property="IsVisible" Value="False" />
                                                </DataTrigger>
                                            </Label.Triggers>
                                        </Label>
                                    </VerticalStackLayout>

                                    <!-- Arrow -->
                                    <Label Grid.Column="2"
                                           Text="›"
                                           FontSize="24"
                                           VerticalOptions="Center"
                                           TextColor="Gray" />
                                </Grid>
                            </Border>
                        </SwipeView>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <!-- Error State -->
        <Border x:Name="ErrorFrame"
                Grid.Row="2"
                IsVisible="False"
                Margin="20"
                Padding="20"
                StrokeShape="RoundRectangle 10"
                Stroke="Transparent"
                StrokeThickness="0"
                BackgroundColor="#FFEBEE"
                VerticalOptions="Center">
            <VerticalStackLayout Spacing="10">
                <Label x:Name="ErrorLabel"
                       TextColor="#C62828"
                       HorizontalOptions="Center" />
                <Button x:Name="RetryButton"
                        Text="Retry"
                        Clicked="OnRetryClicked" />
            </VerticalStackLayout>
        </Border>

    </Grid>


</ContentPage>
