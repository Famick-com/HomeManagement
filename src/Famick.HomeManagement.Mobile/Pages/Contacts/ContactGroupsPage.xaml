<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="Famick.HomeManagement.Mobile.Pages.Contacts.ContactGroupsPage"
             Title="Contacts"
             Shell.NavBarIsVisible="True">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Add" Clicked="OnAddGroupClicked" IconImageSource="plus" />
    </ContentPage.ToolbarItems>

    <Grid RowDefinitions="Auto,Auto,*">

        <!-- Search -->
        <Entry x:Name="SearchEntry"
               Grid.Row="0"
               Placeholder="Search contacts..."
               ReturnType="Search"
               TextChanged="OnSearchTextChanged"
               Margin="10,5" />

        <!-- Filter Chips -->
        <HorizontalStackLayout Grid.Row="1" Spacing="8" Padding="10,0,10,5">
            <Button x:Name="FilterAll"
                    Text="All"
                    Clicked="OnFilterAllClicked"
                    FontSize="13"
                    HeightRequest="32"
                    Padding="12,0"
                    CornerRadius="16"
                    BackgroundColor="{AppThemeBinding Light=#1976D2, Dark=#1565C0}"
                    TextColor="White" />
            <Button x:Name="FilterHouseholds"
                    Text="Households"
                    Clicked="OnFilterHouseholdsClicked"
                    FontSize="13"
                    HeightRequest="32"
                    Padding="12,0"
                    CornerRadius="16"
                    BackgroundColor="{AppThemeBinding Light=#E0E0E0, Dark=#424242}"
                    TextColor="{AppThemeBinding Light=Black, Dark=White}" />
            <Button x:Name="FilterBusinesses"
                    Text="Businesses"
                    Clicked="OnFilterBusinessesClicked"
                    FontSize="13"
                    HeightRequest="32"
                    Padding="12,0"
                    CornerRadius="16"
                    BackgroundColor="{AppThemeBinding Light=#E0E0E0, Dark=#424242}"
                    TextColor="{AppThemeBinding Light=Black, Dark=White}" />
        </HorizontalStackLayout>

        <!-- Loading Indicator -->
        <ActivityIndicator x:Name="LoadingIndicator"
                           Grid.Row="2"
                           IsRunning="True"
                           IsVisible="True"
                           VerticalOptions="Center"
                           HorizontalOptions="Center"
                           Color="{AppThemeBinding Light=#1976D2, Dark=#90CAF9}" />

        <!-- Empty State -->
        <VerticalStackLayout x:Name="EmptyState"
                             Grid.Row="2"
                             IsVisible="False"
                             VerticalOptions="Center"
                             HorizontalOptions="Center"
                             Spacing="10">
            <Label Text="No Households"
                   FontSize="18"
                   FontAttributes="Bold"
                   HorizontalOptions="Center" />
            <Label Text="Tap + to create your first household."
                   FontSize="14"
                   TextColor="Gray"
                   HorizontalOptions="Center" />
            <Button Text="Refresh"
                    Clicked="OnRefreshClicked"
                    Margin="0,20,0,0" />
        </VerticalStackLayout>

        <!-- Group List -->
        <RefreshView x:Name="RefreshContainer"
                     Grid.Row="2"
                     IsVisible="False"
                     Refreshing="OnRefreshing">
            <CollectionView x:Name="GroupCollection"
                            ItemsSource="{Binding Groups}"
                            SelectionMode="Single"
                            SelectionChanged="OnGroupSelected">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <SwipeView>
                            <SwipeView.RightItems>
                                <SwipeItems>
                                    <SwipeItem Text="Edit"
                                               BackgroundColor="#1976D2"
                                               Invoked="OnEditSwiped"
                                               BindingContext="{Binding}" />
                                    <SwipeItem Text="Delete"
                                               BackgroundColor="#D32F2F"
                                               Invoked="OnDeleteSwiped"
                                               BindingContext="{Binding}" />
                                </SwipeItems>
                            </SwipeView.RightItems>
                            <Border Margin="10,4" Padding="12" StrokeShape="RoundRectangle 10"
                                    Stroke="Transparent" StrokeThickness="0"
                                    BackgroundColor="{AppThemeBinding Light=White, Dark=#2A2A2A}">
                                <Grid ColumnDefinitions="50,*,Auto" ColumnSpacing="12">
                                    <!-- Avatar -->
                                    <Border Grid.Column="0"
                                            WidthRequest="50" HeightRequest="50"
                                            StrokeShape="RoundRectangle 25"
                                            Stroke="Transparent"
                                            BackgroundColor="{Binding BackgroundColor}">
                                        <Grid>
                                            <Label Text="{Binding Initials}"
                                                   FontSize="18"
                                                   FontAttributes="Bold"
                                                   TextColor="White"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center" />
                                            <Image Source="{Binding ProfileImageSource}"
                                                   Aspect="AspectFill"
                                                   WidthRequest="50"
                                                   HeightRequest="50">
                                                <Image.Triggers>
                                                    <DataTrigger TargetType="Image"
                                                                 Binding="{Binding ProfileImageSource}"
                                                                 Value="{x:Null}">
                                                        <Setter Property="IsVisible" Value="False" />
                                                    </DataTrigger>
                                                </Image.Triggers>
                                            </Image>
                                        </Grid>
                                    </Border>

                                    <!-- Info -->
                                    <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="2">
                                        <Label Text="{Binding GroupName}"
                                               FontSize="16"
                                               FontAttributes="Bold"
                                               LineBreakMode="TailTruncation"
                                               MaxLines="1" />
                                        <HorizontalStackLayout Spacing="6">
                                            <Border Padding="4,1"
                                                    StrokeShape="RoundRectangle 4"
                                                    Stroke="Transparent"
                                                    BackgroundColor="{Binding BackgroundColor}">
                                                <Label Text="{Binding TypeLabel}"
                                                       FontSize="10"
                                                       TextColor="White" />
                                            </Border>
                                            <Label Text="{Binding MemberCountText}"
                                                   FontSize="12"
                                                   TextColor="Gray"
                                                   VerticalOptions="Center" />
                                        </HorizontalStackLayout>
                                        <Label Text="{Binding PrimaryAddress}"
                                               FontSize="11"
                                               TextColor="Gray"
                                               LineBreakMode="TailTruncation"
                                               MaxLines="1">
                                            <Label.Triggers>
                                                <DataTrigger TargetType="Label"
                                                             Binding="{Binding PrimaryAddress}"
                                                             Value="{x:Null}">
                                                    <Setter Property="IsVisible" Value="False" />
                                                </DataTrigger>
                                            </Label.Triggers>
                                        </Label>
                                    </VerticalStackLayout>

                                    <!-- Arrow -->
                                    <Label Grid.Column="2"
                                           Text="â€º"
                                           FontSize="24"
                                           VerticalOptions="Center"
                                           TextColor="Gray" />
                                </Grid>
                            </Border>
                        </SwipeView>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <!-- Error State -->
        <Border x:Name="ErrorFrame"
                Grid.Row="2"
                IsVisible="False"
                Margin="20"
                Padding="20"
                StrokeShape="RoundRectangle 10"
                Stroke="Transparent"
                StrokeThickness="0"
                BackgroundColor="#FFEBEE"
                VerticalOptions="Center">
            <VerticalStackLayout Spacing="10">
                <Label x:Name="ErrorLabel"
                       TextColor="#C62828"
                       HorizontalOptions="Center" />
                <Button x:Name="RetryButton"
                        Text="Retry"
                        Clicked="OnRetryClicked" />
            </VerticalStackLayout>
        </Border>

    </Grid>

</ContentPage>
