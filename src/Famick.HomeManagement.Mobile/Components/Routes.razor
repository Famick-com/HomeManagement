<ErrorBoundary @ref="_errorBoundary">
    <ChildContent>
        <Router AppAssembly="typeof(MauiProgram).Assembly"
                AdditionalAssemblies="new[] { typeof(Famick.HomeManagement.UI._Imports).Assembly }">
            <Found Context="routeData">
                <AuthorizeRouteView RouteData="routeData" DefaultLayout="typeof(MainLayout)">
                    <NotAuthorized>
                        @if (context.User.Identity?.IsAuthenticated != true)
                        {
                            <RedirectToLogin />
                        }
                        else
                        {
                            <MudContainer MaxWidth="MaxWidth.Small" Class="pa-8">
                                <MudAlert Severity="Severity.Error">
                                    You are not authorized to access this resource.
                                </MudAlert>
                            </MudContainer>
                        }
                    </NotAuthorized>
                    <Authorizing>
                        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
                    </Authorizing>
                </AuthorizeRouteView>
                <FocusOnNavigate RouteData="routeData" Selector="h1" />
            </Found>
            <NotFound>
                <LayoutView Layout="typeof(MainLayout)">
                    <MudContainer MaxWidth="MaxWidth.Small" Class="pa-8 text-center">
                        <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Warning" Class="mb-4" />
                        <MudText Typo="Typo.h4" Class="mb-4">Page Not Found</MudText>
                        <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
                            Sorry, the page you're looking for doesn't exist.
                        </MudText>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/">
                            Go to Dashboard
                        </MudButton>
                    </MudContainer>
                </LayoutView>
            </NotFound>
        </Router>
    </ChildContent>
    <ErrorContent Context="exception">
        <MudContainer MaxWidth="MaxWidth.Small" Class="pa-8">
            <MudAlert Severity="Severity.Error" Class="mb-4">
                <MudText Typo="Typo.h6">Application Error</MudText>
            </MudAlert>
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.body2" Class="mb-2"><strong>Type:</strong> @exception.GetType().FullName</MudText>
                <MudText Typo="Typo.body2" Class="mb-2"><strong>Message:</strong> @exception.Message</MudText>
                @if (exception.InnerException != null)
                {
                    <MudText Typo="Typo.body2" Class="mb-2"><strong>Inner:</strong> @exception.InnerException.Message</MudText>
                }
                <MudText Typo="Typo.caption" Style="white-space: pre-wrap; font-family: monospace; max-height: 300px; overflow-y: auto;">
                    @exception.StackTrace
                </MudText>
            </MudPaper>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-4" OnClick="@Recover">
                Try Again
            </MudButton>
        </MudContainer>
    </ErrorContent>
</ErrorBoundary>

@code {
    private ErrorBoundary? _errorBoundary;

    private void Recover()
    {
        _errorBoundary?.Recover();
    }
}
