@page "/settings/server"
@layout EmptyLayout
@inject ApiSettings ApiSettings
@inject NavigationManager Navigation

<MudThemeProvider Theme="_theme" IsDarkMode="false" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudContainer MaxWidth="MaxWidth.Small" Class="d-flex align-center" Style="height: 100vh;">
    <MudPaper Elevation="3" Class="pa-8" Style="width: 100%;">
        <MudStack Spacing="4" AlignItems="AlignItems.Center">
            <MudIcon Icon="@Icons.Material.Filled.Settings" Size="Size.Large" Color="Color.Primary" />
            <MudText Typo="Typo.h4">Server Settings</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">Configure your Home Management server</MudText>
        </MudStack>

        <MudForm @ref="_form" @bind-IsValid="@_formValid" Class="mt-6">
            <MudTextField @bind-Value="_serverUrl"
                          Label="Server URL"
                          Variant="Variant.Outlined"
                          Placeholder="https://your-server.com"
                          Required="true"
                          RequiredError="Server URL is required"
                          HelperText="Enter the URL of your Home Management server"
                          Class="mb-4" />

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
            }

            @if (_testSuccess)
            {
                <MudAlert Severity="Severity.Success" Class="mb-4">Connection successful!</MudAlert>
            }

            <MudStack Row="true" Spacing="2" Class="mt-4">
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Primary"
                           OnClick="@TestConnection"
                           Disabled="@(!_formValid || _isTesting)"
                           Style="flex: 1;">
                    @if (_isTesting)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <span>Testing...</span>
                    }
                    else
                    {
                        <span>Test Connection</span>
                    }
                </MudButton>

                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           OnClick="@SaveSettings"
                           Disabled="@(!_formValid || _isSaving)"
                           Style="flex: 1;">
                    @if (_isSaving)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <span>Saving...</span>
                    }
                    else
                    {
                        <span>Save & Continue</span>
                    }
                </MudButton>
            </MudStack>
        </MudForm>

        @if (ApiSettings.IsConfigured)
        {
            <MudDivider Class="my-4" />
            <MudButton Variant="Variant.Text"
                       Color="Color.Secondary"
                       FullWidth="true"
                       OnClick="@(() => Navigation.NavigateTo("/login"))">
                Back to Login
            </MudButton>
        }
    </MudPaper>
</MudContainer>

@code {
    private MudForm? _form;
    private bool _formValid;
    private bool _isTesting;
    private bool _isSaving;
    private bool _testSuccess;
    private string _serverUrl = string.Empty;
    private string? _errorMessage;

    private readonly MudTheme _theme = new()
    {
        PaletteLight = new PaletteLight()
        {
            Primary = Colors.Blue.Default,
            Secondary = Colors.Green.Accent4,
        }
    };

    protected override void OnInitialized()
    {
        _serverUrl = ApiSettings.BaseUrl;
    }

    private async Task TestConnection()
    {
        _isTesting = true;
        _errorMessage = null;
        _testSuccess = false;

        try
        {
            using var httpClient = new HttpClient();
            httpClient.Timeout = TimeSpan.FromSeconds(10);

            var testUrl = _serverUrl.TrimEnd('/') + "/health";
            var response = await httpClient.GetAsync(testUrl);

            if (response.IsSuccessStatusCode)
            {
                _testSuccess = true;
            }
            else
            {
                _errorMessage = $"Server returned status {(int)response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Connection failed: {ex.Message}";
        }
        finally
        {
            _isTesting = false;
        }
    }

    private async Task SaveSettings()
    {
        _isSaving = true;
        _errorMessage = null;

        try
        {
            // Normalize the URL
            var normalizedUrl = _serverUrl.TrimEnd('/');
            if (!normalizedUrl.StartsWith("http://") && !normalizedUrl.StartsWith("https://"))
            {
                normalizedUrl = "https://" + normalizedUrl;
            }

            ApiSettings.BaseUrl = normalizedUrl;

            // Navigate to login page
            await Task.Delay(500); // Brief delay for visual feedback
            Navigation.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to save settings: {ex.Message}";
        }
        finally
        {
            _isSaving = false;
        }
    }
}
