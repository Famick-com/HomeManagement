name: Deploy to TestFlight

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      build_number:
        description: 'Build number (auto-incremented if empty)'
        required: false
        type: string

env:
  DOTNET_VERSION: '10.0.x'
  MOBILE_PROJECT: 'src/Famick.HomeManagement.Mobile/Famick.HomeManagement.Mobile.csproj'
  WIDGET_DIR: 'src/Famick.HomeManagement.Mobile/Platforms/iOS/WidgetExtension'
  TEAM_ID: '7A6WPZLCK9'

jobs:
  build-and-upload:
    name: Build iOS & Upload to TestFlight
    runs-on: macos-15
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install MAUI workloads
        run: dotnet workload install maui-ios android

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_26.2.app/Contents/Developer

      - name: Determine build number
        id: build-number
        run: |
          if [ -n "${{ inputs.build_number }}" ]; then
            echo "number=${{ inputs.build_number }}" >> "$GITHUB_OUTPUT"
          else
            echo "number=${{ github.run_number }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Create temporary keychain
        env:
          KEYCHAIN_PASSWORD: ${{ github.run_id }}-${{ github.run_attempt }}
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"

      - name: Import distribution certificate
        env:
          CERTIFICATE_P12: ${{ secrets.APPLE_CERTIFICATE_P12 }}
          CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          CERT_PATH="$RUNNER_TEMP/certificate.p12"
          echo "$CERTIFICATE_P12" | base64 --decode > "$CERT_PATH"
          security import "$CERT_PATH" \
            -k "$KEYCHAIN_PATH" \
            -P "$CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple: -s -k "${{ github.run_id }}-${{ github.run_attempt }}" "$KEYCHAIN_PATH"
          rm "$CERT_PATH"

      - name: Install provisioning profiles
        env:
          APP_PROFILE: ${{ secrets.APPLE_APP_PROVISIONING_PROFILE }}
          WIDGET_PROFILE: ${{ secrets.APPLE_WIDGET_PROVISIONING_PROFILE }}
        run: |
          PROFILES_DIR="$HOME/Library/MobileDevice/Provisioning Profiles"
          mkdir -p "$PROFILES_DIR"

          echo "$APP_PROFILE" | base64 --decode > "$PROFILES_DIR/app.mobileprovision"
          echo "$WIDGET_PROFILE" | base64 --decode > "$PROFILES_DIR/widget.mobileprovision"

          # Extract profile names for verification
          echo "Installed provisioning profiles:"
          for f in "$PROFILES_DIR"/*.mobileprovision; do
            security cms -D -i "$f" 2>/dev/null | grep -A1 '<key>Name</key>' | tail -1 || true
          done

      - name: Extract version from tag
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            FULL_VERSION="${GITHUB_REF#refs/tags/v}"
          else
            FULL_VERSION="0.0.0"
          fi
          # iOS requires X.Y.Z only — strip any prerelease suffix (e.g. 1.0.0-beta10 → 1.0.0)
          IOS_VERSION="${FULL_VERSION%%-*}"
          echo "full=$FULL_VERSION" >> "$GITHUB_OUTPUT"
          echo "ios=$IOS_VERSION" >> "$GITHUB_OUTPUT"

      - name: Build widget extension
        run: |
          WIDGET_PROVISIONING_PROFILE="Famick Widget AppStore" \
          CODE_SIGN_IDENTITY="Apple Distribution" \
          DEVELOPMENT_TEAM="${{ env.TEAM_ID }}" \
          MARKETING_VERSION="${{ steps.version.outputs.ios }}" \
          CURRENT_PROJECT_VERSION="${{ steps.build-number.outputs.number }}" \
            "${{ env.WIDGET_DIR }}/build.sh" --release

      - name: Build iOS app
        run: |
          dotnet publish "${{ env.MOBILE_PROJECT }}" \
            -f net10.0-ios \
            -c Release \
            -r ios-arm64 \
            /p:CodesignKey="Apple Distribution" \
            /p:CodesignProvision="Famick Home AppStore" \
            /p:EnableCodeSigning=true \
            /p:ApplicationDisplayVersion="${{ steps.version.outputs.ios }}" \
            /p:ApplicationVersion="${{ steps.build-number.outputs.number }}"

      - name: Find IPA
        id: find-ipa
        run: |
          IPA_PATH=$(find src/Famick.HomeManagement.Mobile -name "*.ipa" -path "*/publish/*" -type f | head -1)
          if [ -z "$IPA_PATH" ]; then
            echo "Error: No .ipa file found in publish output"
            exit 1
          fi
          echo "path=$IPA_PATH" >> "$GITHUB_OUTPUT"
          echo "IPA found: $IPA_PATH ($(du -h "$IPA_PATH" | cut -f1))"

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: famick-home-${{ steps.build-number.outputs.number }}.ipa
          path: ${{ steps.find-ipa.outputs.path }}
          retention-days: 30

      - name: Upload to TestFlight
        env:
          API_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          # Write API key to one of altool's default search paths
          KEY_DIR="$HOME/.private_keys"
          mkdir -p "$KEY_DIR"
          echo "$API_KEY" > "$KEY_DIR/AuthKey_${API_KEY_ID}.p8"

          xcrun altool --upload-app \
            --type ios \
            --file "${{ steps.find-ipa.outputs.path }}" \
            --apiKey "$API_KEY_ID" \
            --apiIssuer "$API_ISSUER_ID"

      - name: Cleanup
        if: always()
        run: |
          # Delete temporary keychain
          if [ -n "$KEYCHAIN_PATH" ] && [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH" 2>/dev/null || true
          fi
          # Delete API key
          rm -rf "$HOME/.private_keys" 2>/dev/null || true
          # Delete provisioning profiles
          rm -f "$HOME/Library/MobileDevice/Provisioning Profiles/app.mobileprovision" 2>/dev/null || true
          rm -f "$HOME/Library/MobileDevice/Provisioning Profiles/widget.mobileprovision" 2>/dev/null || true
